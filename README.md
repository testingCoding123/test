# Техническое задание: Telegram Bot для мониторинга и перепостинга контента iHerb

## 1. Общее описание проекта

### 1.1 Назначение
Telegram бот для автоматического мониторинга каналов-доноров, обработки постов с заменой реферальных ссылок и публикации в целевые каналы.

### 1.2 Архитектура системы
Система состоит из двух основных компонентов:
- **Монитор каналов** - использует User API для чтения постов из каналов-доноров
- **Telegram Bot** - использует Bot API для публикации обработанных постов

## 2. Функциональные требования

### 2.1 Мониторинг каналов-доноров
- **Количество каналов**: Поддержка неограниченного количества каналов-доноров
- **Частота проверки**: Каждые 5 минут
- **Фильтрация**: Исключение рекламных постов, обработка только постов с ссылками на iHerb
- **Источник данных**: Использование User API через session.json файл

### 2.2 Обработка постов
- **Замена ссылок iHerb**: Замена реферальных кодов в ссылках на iHerb
  - Пример: `BWS9360` → `JYB8934`
- **Замена ссылок на каналы**: Замена ссылок типа `t.me/channel_name` на настроенную ссылку
- **Логирование**: Запись всех замен ссылок с временными метками
- **Добавление подписей**: Возможность добавления кастомных подписей к постам

### 2.3 Публикация контента
- **Количество каналов**: Неограниченное количество целевых каналов
- **Формат**: Пересылка обработанного поста в технический канал, затем публикация в целевые каналы
- **Очередь**: Прямая публикация без очереди

### 2.4 Уведомления
- **Ошибки**: Уведомления администраторов об ошибках мониторинга/публикации
- **Статистика**: Логирование количества обработанных постов и замененных ссылок

## 3. Технические требования

### 3.1 Язык программирования
- **Основной язык**: Python 3.8+

### 3.2 Зависимости
- `telethon` - для User API (мониторинг каналов)
- `python-telegram-bot` - для Bot API (публикация постов)
- `asyncio` - для асинхронной работы
- `json` - для конфигурации
- `logging` - для логирования
- `re` - для регулярных выражений (замена ссылок)

### 3.3 Хранение данных
- **Локальное хранение**: JSON файлы для конфигурации и логов
- **База данных**: Не требуется (локальное хранение достаточно)

### 3.4 Конфигурация
- **Формат**: JSON файл
- **Доступ**: Только для администраторов
- **Параметры**:
  - Список каналов-доноров
  - Список целевых каналов
  - Реферальный код для замены
  - Ссылка на канал для замены
  - Настройки фильтрации

## 4. Структура проекта

```
iherb_bot/
├── config/
│   ├── config.json          # Основная конфигурация
│   └── session.json         # User API сессия
├── src/
│   ├── monitor.py           # Монитор каналов-доноров
│   ├── bot.py               # Telegram Bot
│   ├── processor.py         # Обработчик постов
│   ├── config_manager.py    # Менеджер конфигурации
│   └── logger.py            # Система логирования
├── logs/                    # Папка с логами
├── requirements.txt          # Зависимости Python
├── main.py                  # Главный файл запуска
└── README.md                # Документация
```

## 5. Детальные требования к компонентам

### 5.1 Монитор каналов (monitor.py)
- Асинхронный мониторинг всех каналов-доноров
- Фильтрация постов по наличию ссылок на iHerb
- Пересылка подходящих постов в технический канал
- Обработка ошибок и повторные попытки

### 5.2 Обработчик постов (processor.py)
- Парсинг ссылок в тексте постов
- Замена реферальных кодов в ссылках iHerb
- Замена ссылок на каналы
- Добавление кастомных подписей
- Логирование всех изменений

### 5.3 Telegram Bot (bot.py)
- Мониторинг технического канала
- Получение обработанных постов
- Публикация в целевые каналы
- Обработка команд администратора

### 5.4 Менеджер конфигурации (config_manager.py)
- Загрузка/сохранение конфигурации
- Валидация параметров
- Горячая перезагрузка конфигурации

## 6. Конфигурационный файл

```json
{
  "user_api": {
    "api_id": "YOUR_API_ID",
    "api_hash": "YOUR_API_HASH",
    "session_name": "session"
  },
  "bot": {
    "token": "YOUR_BOT_TOKEN"
  },
  "channels": {
    "donor_channels": [
      "channel1_username",
      "channel2_username"
    ],
    "technical_channel": "technical_channel_username",
    "target_channels": [
      "target1_username",
      "target2_username"
    ]
  },
  "replacements": {
    "referral_code": "JYB8934",
    "channel_link": "t.me/your_channel"
  },
  "filters": {
    "exclude_keywords": ["реклама", "спонсор", "ad"],
    "include_patterns": ["iherb.com", "iherb.ru"]
  },
  "settings": {
    "check_interval": 300,
    "custom_signature": "Подпись к посту"
  }
}
```

## 7. Требования к безопасности

- Хранение API ключей в защищенном месте
- Логирование всех операций
- Ограничение доступа к конфигурации только для администраторов
- Валидация входных данных

## 8. Требования к производительности

- Обработка поста: не более 30 секунд
- Мониторинг: каждые 5 минут без задержек
- Поддержка неограниченного количества каналов

## 9. Требования к развертыванию

- Возможность запуска на Linux/Windows серверах
- Автоматический перезапуск при сбоях
- Логирование в файлы с ротацией
- Простота настройки через конфигурационный файл

## 10. Дополнительные возможности

- Веб-интерфейс для мониторинга (опционально)
- API для внешнего управления
- Интеграция с системами аналитики
- Поддержка различных форматов постов (текст, медиа, опросы)

## 11. Критерии приемки

- [ ] Бот успешно мониторит все настроенные каналы-доноры
- [ ] Корректно заменяет реферальные ссылки в постах
- [ ] Публикует обработанные посты во все целевые каналы
- [ ] Логирует все операции
- [ ] Обрабатывает ошибки и уведомляет администраторов
- [ ] Работает стабильно 24/7
- [ ] Конфигурация легко редактируется

## 12. Ограничения и риски

- Зависимость от стабильности User API и Bot API Telegram
- Возможные ограничения на количество запросов к API
- Необходимость регулярного обновления session.json
- Риск блокировки аккаунта при нарушении правил Telegram
